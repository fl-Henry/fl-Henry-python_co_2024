# Занятие 1: Docker-compose. Базы данных в Docker.

## 1. Введение в Docker-compose

### Определение Docker-compose
Docker-compose — это инструмент для определения и запуска многоконтейнерных Docker-приложений. Он позволяет разработчикам описывать, как должны взаимодействовать различные сервисы в одном приложении, используя файл конфигурации в формате YAML (обычно называется `docker-compose.yml`). 

С помощью Docker-compose можно легко управлять множеством контейнеров, обеспечивая автоматизацию процессов запуска, остановки и конфигурации. Например, в приложении может быть сервер, база данных и кэш, каждый из которых работает в своем контейнере, но все они могут быть настроены и запущены одной командой.

### Преимущества использования Docker-compose
Использование Docker-compose предоставляет несколько значительных преимуществ:

1. **Упрощение управления многоконтейнерными приложениями**:
   - Docker-compose позволяет объединять все компоненты приложения в одном месте. Разработчики могут управлять зависимостями между сервисами, определяя, как они должны взаимодействовать друг с другом.

2. **Централизованная настройка**:
   - Конфигурация всех сервисов находится в одном файле (`docker-compose.yml`), что упрощает процесс разработки и развертывания. Можно легко вносить изменения в конфигурацию, добавляя или удаляя сервисы без необходимости редактирования отдельных файлов или команд.

3. **Автоматизация развертывания**:
   - С помощью одной команды `docker-compose up` можно запустить все сервисы, что значительно упрощает процесс разработки. Аналогично, команда `docker-compose down` позволяет остановить и удалить все контейнеры, связанные с приложением, в одной команде.

4. **Легкость в тестировании**:
   - Docker-compose облегчает создание изолированных тестовых сред. Разработчики могут легко настроить окружение, аналогичное производственному, для тестирования новых функций или исправления ошибок.

5. **Поддержка различных окружений**:
   - Можно легко создавать разные конфигурации для разработки, тестирования и производства, используя разные файлы или параметры в одном и том же файле `docker-compose.yml`.

6. **Гибкость и масштабируемость**:
   - Docker-compose позволяет легко масштабировать сервисы. Можно задать количество экземпляров каждого сервиса, что упрощает управление нагрузкой на приложение.

## 2. Основные команды Docker-compose

### Запуск и остановка приложений
1. **`docker-compose up`**
   - Эта команда используется для создания и запуска всех сервисов, определённых в файле `docker-compose.yml`. При первом запуске Docker-compose автоматически загружает необходимые образы, создаёт контейнеры и запускает их.
   - **Флаги**:
     - `-d`: Запускает контейнеры в фоновом режиме (detached mode), что позволяет продолжать работу в терминале, не блокируя его.
     - `--build`: Принуждает Docker-compose пересобрать образы перед запуском, что полезно, если изменения были внесены в Dockerfile.

   **Пример**: `docker-compose up -d`

2. **`docker-compose down`**
   - Останавливает и удаляет все контейнеры, сети и образы, созданные для текущего приложения. Это полезно для очистки окружения и освобождения ресурсов.
   - **Флаги**:
     - `--volumes`: Дополнительно удаляет тома, связанные с контейнерами, что помогает избежать утечек данных.

   **Пример**: `docker-compose down --volumes`

### Управление контейнерами
1. **`docker-compose ps`**
   - Показывает список всех контейнеров, запущенных с помощью Docker-compose, вместе с их статусом и другими основными данными (например, порты и имена контейнеров).
   - Это полезно для проверки состояния ваших сервисов.

   **Пример**: `docker-compose ps`

2. **`docker-compose logs`**
   - Позволяет просматривать вывод журналов всех контейнеров или конкретного сервиса. Это особенно важно для отладки и мониторинга работы приложения.
   - **Флаги**:
     - `-f`: Позволяет следить за журналами в реальном времени.

   **Пример**: `docker-compose logs -f`

3. **`docker-compose exec`**
   - Позволяет выполнять команды внутри запущенного контейнера. Это полезно для выполнения административных задач или диагностики.
   - **Пример**: `docker-compose exec <service_name> <command>`, где `<service_name>` — имя сервиса из `docker-compose.yml`, а `<command>` — команда, которую нужно выполнить.

   **Пример**: `docker-compose exec web bash`

### Обновление и масштабирование
1. **`docker-compose build`**
   - Эта команда пересобирает образы для всех сервисов, указанных в файле `docker-compose.yml`. Полезно, если были внесены изменения в Dockerfile или зависимости.
   - Можно использовать в сочетании с флагом `--no-cache`, чтобы игнорировать кэшированные слои и принудительно пересобрать образы.

   **Пример**: `docker-compose build`

2. **`docker-compose scale`**
   - Позволяет изменять количество экземпляров для конкретного сервиса. Это позволяет легко масштабировать приложение в зависимости от нагрузки.
   - Например, можно увеличить количество контейнеров для сервиса, обрабатывающего запросы, чтобы улучшить производительность.

   **Пример**: `docker-compose scale web=3`, где `web` — имя сервиса.

3. **`docker-compose up --scale`**
   - Альтернатива команде `scale`, позволяет одновременно запускать и масштабировать сервисы, не вызывая необходимость их предварительного остановки.

   **Пример**: `docker-compose up --scale web=3`

## 3. Структура файла docker-compose.yml

### Формат файла YAML
YAML — это формат сериализации данных, который используется для представления конфигурационной информации. Он читаем и удобен для человека, что делает его идеальным для написания конфигурационных файлов.

- **Основные особенности**:
  - Отступы: Используются для определения вложенности. Один уровень вложенности соответствует двум пробелам (не используйте табуляцию).
  - Ключи и значения: Записываются в формате `ключ: значение`.
  - Списки: Обозначаются с помощью дефиса (`-`).

**Пример**:
```yaml
services:
  web:
    image: postgres
```

### Основные разделы файла
Файл `docker-compose.yml` состоит из нескольких ключевых разделов, которые определяют конфигурацию приложения:

1. **`version`**:
   - Указывает версию файла конфигурации Docker Compose. Это необходимо для обеспечения совместимости с различными версиями Docker Compose.

   **Пример**:
   ```yaml
   version: '3.8'
   ```

2. **`services`**:
   - Определяет контейнеры, которые будут запущены. Каждый сервис представляет отдельный контейнер, и для каждого из них можно задать различные параметры.

   **Пример**:
   ```yaml
   services:
     web:
       image: postgres
   ```

3. **`volumes`**:
   - Указывает тома, которые будут использоваться контейнерами для хранения данных. Это позволяет сохранить данные даже при остановке или удалении контейнеров.

   **Пример**:
   ```yaml
   volumes:
     # - host_path:container_path
     - ./data/pg_data:/usr/app/data/pg_data
   ```

4. **`networks`**:
   - Определяет сети, в которых будут работать сервисы. Это позволяет контролировать взаимодействие между контейнерами.

   **Пример**:
   ```yaml
   networks:
      - frontend
      - backend
   ```

5. **`ports`**:
   - Используется для определения, какие порты контейнера будут доступны извне. Это позволяет другим сервисам и пользователям взаимодействовать с приложением, работающим внутри контейнера.

   **Пример**:
   ```yaml
   ports:
      # host_port:container_port  
      - 5432:5432
   ```


6. **`environment`**:
   - Используется для низначения переменных окружения в контейнере. Эти переменные могут настраивать поведение приложения внутри контейнера или задавать конфигурацию, такую как учетные данные для баз данных.

   **Пример**:
   ```yaml
    environment:
      POSTGRES_USER: ${DB_USERNAME}
      POSTGRES_PASSWORD: ${DB_PASS}
      POSTGRES_DB: ${DB_NAME}
      PGDATA: /usr/app/data/pg_data
   ```

### Примеры конфигурации для баз данных
Приведем примеры конфигурации для различных баз данных, чтобы лучше понять, как структурировать файл `docker-compose.yml`.

1. **Пример конфигурации для MySQL**:
```yaml
services:
  mysql:
    image: mysql
    environment:
      MYSQL_ROOT_PASSWORD: pass
      MYSQL_DATABASE: db
      MYSQL_USER: user
      MYSQL_PASSWORD: pass
    ports:
      - 3306:3306
    volumes:
      - ./data/mysql:/var/lib/mysql
```

2. **Пример конфигурации для PostgreSQL**:
```yaml
services:
  postgres:
    image: postgres
    restart: always
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: pass
      POSTGRES_DB: db
      PGDATA: /usr/app/data/pg_data
    volumes:
      - ./data/pg_data:/usr/app/data/pg_data
    ports:
      - 5432:5432

```

3. **Пример конфигурации для MongoDB**:
```yaml
services:
  mongodb:
    image: mongo
    environment:
      MONGO_INITDB_DATABASE: db
      MONGO_INITDB_ROOT_USERNAME: user
      MONGO_INITDB_ROOT_PASSWORD: pass
    ports:
      - 27017:27017
    volumes:
      - ./data/mongodb:/data/db

```


### Конспект раздела IV: Развертывание базы данных с помощью Docker-compose

## 4. Развертывание базы данных с помощью Docker-compose

### 4.1 Пример файла docker-compose.yml для MySQL

Развертывание базы данных MySQL с использованием Docker-compose позволяет быстро и эффективно создать среду для работы с этой СУБД. Рассмотрим, как это сделать, используя файл `docker-compose.yml`.

#### Пример файла `docker-compose.yml` для MySQL:
```yaml
services:
  mysql:
    image: mysql:8.4
    environment:
      MYSQL_ROOT_PASSWORD: pass
      MYSQL_DATABASE: db
      MYSQL_USER: user
      MYSQL_PASSWORD: pass
    ports:
      - 3306:3306
    volumes:
      - ./data/mysql:/var/lib/mysql

```

#### Определение сервиса MySQL
- **`services`**: Этот раздел определяет контейнеры, которые будут запущены. Здесь мы создаём сервис с именем `mysql`.
- **`image: mysql:8.4`**: Указывает, что для создания контейнера будет использован официальный образ MySQL версии 8.4. Использование конкретной версии образа помогает избежать проблем с совместимостью в будущем.

#### Настройка переменных окружения
Переменные окружения используются для настройки базы данных при её первом запуске. В нашем примере мы используем несколько ключевых переменных:

- **`MYSQL_ROOT_PASSWORD`**: Устанавливает пароль для пользователя `root`. Это обязательный параметр для безопасности базы данных.
  
- **`MYSQL_DATABASE`**: Указывает имя базы данных, которая будет автоматически создана при старте контейнера. В нашем случае это `mydb`.

- **`MYSQL_USER`**: Определяет имя нового пользователя, который будет иметь доступ к созданной базе данных.

- **`MYSQL_PASSWORD`**: Устанавливает пароль для нового пользователя, созданного в предыдущем параметре.

Эти переменные позволяют вам заранее настроить базу данных, минимизируя необходимость ручной настройки после запуска контейнера.

#### Использование volumes для хранения данных
- **`volumes`**: Этот раздел управляет постоянным хранилищем данных, которые могут использоваться контейнерами. В нашем случае мы определяем том `db_data`, который будет использоваться для хранения данных MySQL.

- **`- ./data/mysql:/var/lib/mysql`**: Указывает, что данные базы данных будут сохраняться в директории `./data/mysql`, который смонтирован в стандартную директорию MySQL для хранения данных (`/var/lib/mysql`). Это позволяет сохранять данные между перезапусками контейнера, обеспечивая их сохранность даже если контейнер будет удалён.


### 4.2 Пример файла docker-compose.yml для PostgreSQL

Развертывание базы данных PostgreSQL с помощью Docker-compose предоставляет удобный способ создания и настройки базы данных в контейнере. Рассмотрим пример файла `docker-compose.yml` для PostgreSQL.

#### Пример файла `docker-compose.yml` для PostgreSQL:
```yaml
services:
  postgres:
    image: postgres:16.4
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: pass
      POSTGRES_DB: db
      PGDATA: /usr/app/data/pg_data
    ports:
      - 5432:5432
    volumes:
      - ./data/pg_data:/usr/app/data/pg_data
    #   - ./init.sql:/docker-entrypoint-initdb.d/init.sql

```

#### Конфигурация сервиса PostgreSQL
- **`services`**: Определяет контейнеры, которые будут развернуты. Мы создаём сервис с именем `postgres`.
- **`image: postgres:16.4`**: Указывает, что мы будем использовать официальный образ PostgreSQL версии 16.4. Задание конкретной версии помогает избежать проблем с несовместимостью.

- **`environment`**: Этот раздел настраивает переменные окружения для сервиса PostgreSQL:
  - **`POSTGRES_DB`**: Устанавливает имя базы данных, которая будет создана при старте контейнера (в нашем случае `mydb`).
  - **`POSTGRES_USER`**: Определяет имя пользователя, который будет создан при инициализации базы данных.
  - **`POSTGRES_PASSWORD`**: Устанавливает пароль для этого пользователя.
  - **`PGDATA`**: Устанавливает путь для дериктории внутни контейнера, в котором будет храниться база данных.

Эти переменные позволяют настроить PostgreSQL сразу после его запуска, что упрощает процесс.

#### Установка начальных данных через `initdb`
- **`volumes`**: Этот раздел используется для определения томов, которые будут подключены к контейнеру.
  - **`- ./data/pg_data:/usr/app/data/pg_data`**: Определяет директорию для хранения данных базы данных. Данные будут сохраняться между перезапусками контейнера.
  - **`- ./init.sql:/docker-entrypoint-initdb.d/init.sql`**: Подключает локальный файл `init.sql` к специальной директории внутри контейнера (`/docker-entrypoint-initdb.d/`). PostgreSQL автоматически выполнит SQL-скрипты, находящиеся в этой директории, при первой инициализации базы данных.

#### Пример файла `init.sql`:
```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100),
    email VARCHAR(100) UNIQUE NOT NULL
);

INSERT INTO "users" ("name", "email") VALUES
('Alice', 'alice@mail.com'),
('Sam',	'sam@mail.com');
```
- **Объяснение**:
  - Этот SQL-скрипт создаёт таблицу `users` с тремя полями: `id`, `name` и `email`. Этот скрипт будет автоматически выполнен при первой инициализации базы данных, создавая нужную структуру данных сразу после запуска контейнера.


### 4.3 Запуск многоконтейнерного приложения с базой данных, приложением и Adminer

В этом разделе мы рассмотрим, как развернуть многоконтейнерное приложение, которое включает в себя базу данных (PostgreSQL), основное приложение и инструмент управления базами данных Adminer. Adminer — это легковесное веб-приложение для управления базами данных, которое удобно использовать для выполнения операций над базами данных через интерфейс.

#### Пример файла `docker-compose.yml` для многоконтейнерного приложения:
```yaml
version: '3.8'

services:
  app:
    image: myapp:latest
    build:
      context: ./app
    depends_on:
      - postgres
    ports:
      - 5000:5000
    environment:
      DATABASE_URL: postgres://user:pass@postgres:5432/db

  postgres:
    image: postgres:13
    environment:
      POSTGRES_DB: db
      POSTGRES_USER: user
      POSTGRES_PASSWORD: pass
      PGDATA: /usr/app/data/pg_data
    volumes:
      - ./data/pg_data:/var/lib/postgresql/data

  adminer:
    image: adminer
    ports:
      - 8080:8080

```

#### Конфигурация сервиса приложения
- **`app`**: Этот сервис представляет ваше основное приложение. 
  - **`image: myapp:latest`**: Указывает, что для этого приложения используется образ `myapp`. 
  - **`build`**: Определяет контекст сборки для образа, указывая на директорию, где находится Dockerfile.
  - **`depends_on`**: Указывает, что приложение зависит от сервиса PostgreSQL и будет запущено после его запуска.
  - **`ports`**: Открывает порт `5000` на хосте, чтобы к приложению можно было получить доступ через `http://localhost:5000`.
  - **`environment`**: Передаёт переменную `DATABASE_URL`, которая будет использоваться приложением.

#### Конфигурация сервиса PostgreSQL
- **`postgres`**: Сервис для развертывания базы данных PostgreSQL.
  - **`image: postgres:13`**: Использует образ PostgreSQL версии 13.
  - **`environment`**: Задаёт переменные окружения для создания базы данных, пользователя и пароля, как было описано ранее.
  - **`volumes`**: Использует том `db_data` для хранения данных базы данных.

#### Конфигурация сервиса Adminer
- **`adminer`**: Сервис предоставляющий веб-интерфейс управления базой данных.
  - **`image: adminer`**: Использует официальный образ Adminer.
  - **`ports`**: Открывает порт `8080` на хосте для доступа к Adminer через `http://localhost:8080`.

#### Запуск многоконтейнерного приложения
Для запуска всего приложения с базой данных и Adminer нужно выполнить команду:

```bash
docker-compose up -d
```
- **`-d`**: Запускает все контейнеры в фоновом режиме.

После выполнения этой команды:
- Приложение будет доступно по адресу `http://localhost:5000`.
- Adminer можно открыть по адресу `http://localhost:8080`, где вы сможете ввести данные для подключения к базе данных:
  - **Сервер**: `postgres`
  - **Имя пользователя**: `user`
  - **Пароль**: `pass`
  - **База данных**: `db`


## Полезные команды 

### Удаление контейнеров
```bash
# bash (Linux/MacOS)

# Remove all the containers
docker rm -f $(docker ps -a -q)
```
```powershell
# powershell (Windows)

# Stop all the containers
docker ps -aq | % { docker stop $_ }

# Remove all the containers
docker ps -aq | % { docker rm $_ }

# Stop and remove all the containers
docker ps -aq | % { docker stop $_ } | % { docker rm $_ }

```

